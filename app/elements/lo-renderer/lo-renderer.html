<!-- Copyright (c) 2015 The Locals Project Authors. All rights reserved.
See authors.md for a list of all members.
 -->
 
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../lo-peers/lo-peers.html">

<link rel="import" href="../../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animatable.html">

<link rel="import" href="../../bower_components/neon-animation/neon-shared-element-animatable-behavior.html">

<link rel="import" href="../../bower_components/neon-animation/neon-shared-element-animation-behavior.html">
<link rel="import" href="../../bower_components/neon-animation/animations/hero-animation.html">

<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">

<dom-module id="lo-renderer">
 <style>
    :host {
      display: block;
      height: 100vh;
      overflow: none;
      margin: 0px;
      padding: 0px;

      background-color: transparent;

      --obj-calc: calc(92vw/2);
      --avatar-calc: 92vw;

      --val-size: 90px;

      --obj-kleur: var(--primary-gray);

      --p-size: 14px;
      --p-valids: 12px;
      overflow-x: scroll;
      overflow-y: none;

    }

    .scrollstage {
      width: 100vw;
      @apply(--layout-vertical);
      @apply(--layout-center);
    }

    .objectscanvas {
      height: 100vh;
      margin: 0px;
      padding: 0px;
    }


    #toolbar {
      height: 90px;
      width: 100vw;
      padding: 15px;
      box-sizing:border-box;
      color: black;
      @apply(--layout-horizontal);
      @apply(--layout-center-center);
      background-color: transparent;
    }


    .topbtn {
      background-color: rgba(255,255,255,0.0);

      height: 60px;
      width: 60px;
      border-radius: 50%;
      border: none;
      outline: 0; 
      margin: 0px;
      padding: 0px;

    }
    .topbtn img {
      margin: 0px;
      padding: 0px;
      width: 100%;
      height: 100%;
    }




    .menubtn {
      height: 60px;
      width: 60px;
      border: none;
      outline: 0;
      margin: 8px;
      padding: 0px;
      background-color: transparent;
    }

    .menubtn img {
      width: 100%;
      height: 100%;
      margin: 0px;
      padding: 0px;
    }






    .objectscollection2 {
      width: 92vw;
      @apply(--layout-horizontal);
            @apply(--layout-start);

      @apply(--layout-wrap);
      margin: 0px;
      padding: 0px;
    }




    .object {
      width: var(--obj-calc);
      background-color: transparent;
      @apply(--layout-vertical);
      @apply(--layout-center-center);

      padding: 8px;
      box-sizing:border-box;


    }



    #Avatar {
      width: var(--avatar-calc);
      max-width: 400px;

    }

    #labs002-avatar {
      height: var(--avatar-calc);
      max-height: 400px;
      border-radius: 2px 2px 0px 0px;
    }


    .objectvaluesbar {
      width: 100%;
      margin: -2px 0px 0px 0px;
      padding: 15px 15px 15px 20px;

      background-color: #fafafa;
      height: 60px;
      @apply(--layout-horizontal);
      @apply(--layout-center-center);
      box-sizing:border-box;
      box-shadow: 0px 2px 2px rgba(0,0,0,1);

      border-radius: 0px 0px 2px 2px;
    }




    .valids {
      @apply(--layout-horizontal);
      @apply(--layout-end-justified);

      @apply(--layout-center);
      width: 20%;
      min-width: 40px;
      height: 100%;
    }

    .valids img {
      height: 15px;
      width: 15px;
    }

    .valids p {
      padding: 0px;

      margin: 0px 5px 0px 0px;

      font-size: var(--p-valids);
      font-family: OpensansBold;
      color: #333333;
    }

    lo-previewnext {
      width: 100%;
      height: var(--obj-calc);
      box-shadow: 0px 2px 2px rgba(0,0,0,1);
      border-radius: 2px 2px 0px 0px;
      }

    .objectfirstvalue {
      width: 100%;
      @apply(--layout-horizontal);
      @apply(--layout-center);
      width: 80%;
    overflow: hidden;
    white-space: nowrap;
    text-overflow:ellipsis;
    }

    .objectfirstvalue p {
      width: 100%;
      text-align: left;
      margin: 0px;
      padding: 0px;
      font-family: Opensans;
      font-size: var(--p-size);
      color: #666666;
    overflow: hidden;
    white-space: nowrap;
    text-overflow:ellipsis;
    }

    .square {
      width: 100px;
      height: 100px;
      background-color: transparent;
    }
</style>

<template> 
  <neon-animated-pages selected="{{selected}}" id="vierkantje">
    <neon-animatable>
      <div class="container">
      <div id="toolbar"> 
        <button class="backbtn" on-tap="back">
          <svg version="1.1" id="Laag_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           width="40px" height="40px" viewBox="0 0 40 40" enable-background="new 0 0 40 40" xml:space="preserve">
          <polyline fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" points="7.834,15.231 20.083,27.375 32.75,15.129 
            "/>
          </svg>
        </button>
      </div>
      <div id="rendercanvas">
      </div>
      <div class="valuesbox" on-tap="toggleCollapse">
        <div class="values">
          <p>{{objectdata.firstval}}</p>        
<!--           <iron-collapse id="collapse">
 -->          <template is="dom-repeat" items="{{dataarray}}">
            <p>X <span>{{item}}</span></p>
          </template>
<!--           </iron-collapse>
 --><!--         <div class="valuesillustration"> 
          <img src="../../images/morevals.svg">
        </div> -->
        </div>
      </div>
      <div class="validsbox">
        <div class="valids" on-tap="toPeerlist">
          <p>{{objectpeers.length}}</p>
          <img src="../../images/accept-small.svg">
        </div>
      </div>
<!--         <template is="dom-if" if="{{activ}}">
          <div class="renderbtns">
          <template is="dom-if" if="{{!opened}}">
            <button on-tap="toVisual">
              <img src="../../images/visualbtn.svg">
            </button>
            <button on-tap="toValues" class="values">
              <img src="../../images/values.svg">
            </button>
            <button class="accepter"  on-tap="toPeerlist">
              <img src="../../images/accept.svg">
              <p><span>{{objectpeers.length}}</span></p>
            </button>
          </template>
          </div>
        </template>
        <template is="dom-if" if="{{opened}}">
          <div class="confirmbtns">
            
            <button on-tap="cancel" class="confirmbtn neg">
              <img src="../../images/decline.svg">
            </button>
            <button on-tap="confirm" class="confirmbtn">
              <img src="../../images/accept.svg">
            </button>
          </div>
        </template> -->
  </div>
    </neon-animatable>
    <neon-animatable>
      <lo-peers peers="{{objectpeers}}" on-go-back="_toBack"></lo-peers>
    </neon-animatable>
</neon-animated-pages>
</template>

</dom-module>
<script>
(function() {

  function importPage(url){
    return new Promise(function(resolve, reject){
      Polymer.Base.importHref(url, function(e){
        resolve(e.target.import);
      }, reject);
    });
  };

  var elem; 
  var object;

  Polymer({
    is: 'lo-renderer',

    behaviors: [Polymer.NeonSharedElementAnimatableBehavior],

    properties: {
      objectname: {
        type: String
      },

      objectconfig: {
        type: Object,
        notify: true
      },

      objectdata: {
        type: Object,
        observer: "_dataset",
        notify: true
      },

      objectcomponent: {
        type: String
      },

      hash: {
        type: String
      },

      activ: {
        type: Boolean,
        value: false,
        notify: true
      },

      opened: {
        type: Boolean,
        value: false
      },

      preview: {
        type: Boolean,
        value: true,
        notify: true
      },

      swiper: {
        type: Number,
        value: 0,
        observer: '_swipy',
        notify: true
      },

      locked: {
        type: Boolean,
        value: false,
        notify: true
      },

      animationConfig: { 
        value: function(){
          return {
            'entry': {
              name: 'hero-animation',
              id: 'hero',
              toPage: this
            },
            'exit': {
              name: 'hero-animation',
                id: 'hero',
                fromPage: this
            }
          }
        }
      },

      sharedElements: {
        value: function(){
          return {
            'hero': this.$.vierkantje
          }
        }
      }    
    },

    listeners: {

      down: 'mouseDown',
      up: 'mouseUp',
      track: 'mouseTrack'
      // this event is fired when the animation finishes
      // 'neon-animation-finish': '_onNeonAnimationFinish'
    },

    mouseDown: function(e, detail) {
      //console.log("DOWN:", e.detail.y);
      this.downmouse = e.detail.y;
    },

    mouseUp: function(e, detail) {
      //console.log("UP:", e.detail.y);
      this.upmouse = e.detail.y;
    },

    mouseTrack: function(){
      this.swiper = this.downmouse - this.upmouse;
    },

    _swipy: function(){
      if(this.swiper>0){
        this.back();
      };
    },

    attached: function() {
      this.async(function() {
      //console.log(this.localName + '#' + this.id + ' was attached');
      //this.selected = 1;
      });
    },

    ready: function(){
      this.selected = 0;
      this.dataarray = [{NAAM:'ADAD'}];
      this.oldconfig = this.objectconfig;
      this.newconfig = this.objectconfig;
      this.entryAnimation = 'slide-from-right-animation';
      this.exitAnimation = 'slide-left-animation';
      this.addEventListener('new-peer', function(){
        this.validate();
      });
    },

    back: function(){
      this.fire('change-stage', { stage: 0 });
      this.selected = 0;
      this.opened = false;
      //console.log("doet dit wel iets");
      var coll = document.querySelector("lo-objectscollection");
      coll._objectChanged();
    },

    _dataset: function(){
      var that = this;
      if(this.objectcomponent){      
      //this.importHref("../elements/labs002-components/"+this.objectcomponent+".html", function(e) {
        var that = this;
        importPage("elements/labs002-components/"+this.objectcomponent+".html").then(function(){
          var rendercanvas = that.$.rendercanvas;
          rendercanvas.innerHTML = '';
          elem = document.createElement(that.objectcomponent);
          //var newelem = document.querySelector("labs002-avatar");
          // e.target.import is the import document.
          //console.log(elem, "config: ", that.objectconfig);
          console.log(elem, "data: ", that.objectdata);
          elem.objectconfig = that.objectconfig;
          elem.objectdata = that.objectdata;
          elem.objectname = that.objectname;
          elem.locked = that.locked;
          elem.objecthash = that.hash;
          elem.edit = false;
          elem.active = false;
          elem.opened = false;
          elem.selected = 0;
          elem.mode = 0;
          elem.id = that.objectname;
          //console.log("Data array: ",dataarray);
          rendercanvas.appendChild(elem);
        }, function(e) {
           //console.log('import',e);
          // loading error
        });
      };
    },

    _data: function(){
      // Maak eerst het render plaatske leeg
      //console.log('data changed', this.objectdata);
    },

    _config: function(){
      // Maak eerst het render plaatske leeg
      //console.log('config changed', this.objectconfig);
      this.newconfig = this.objectconfig;
    },

    toValues: function(){
      //var object = document.getElementById(this.objectname);
      object = this.$.rendercanvas.firstChild;
      console.log("RENDERER: ", object);
      object.selected = 1;
      this.opened = true;
      // this.selected = 1;
      object.edit = true;
      this.customStyle['--bg-kleur'] = 'white'; 
      this.updateStyles();
    },

    toVisual: function(){
      //var object = document.getElementById(this.objectname);
      object = this.$.rendercanvas.firstChild;
      //object.selected = 1;
      this.opened = true;
      object.edit = true;
    },

    toPeerlist: function(){
      this.entryAnimation = 'slide-from-right-animation';
      this.exitAnimation = 'slide-left-animation';
      this.selected = 1;
    },

    toObject: function(){
      this.selected = 0;
    },

    validate: function(){
      this.fire('add-getuige', { objectname: this.objectname, objectconfig: JSON.stringify(this.objectconfig), objectdata: JSON.stringify(this.objectdata), userid: this.publickey, hash: this.hash });
    },

    open: function(){
      var object = document.getElementById(this.objectname);
      object.opened = true;
      this.opened = true;
      this.activ = false;
    },

    cancel: function(){
      var object = document.getElementById(this.objectname);
      object.objectconfig = this.oldconfig;
      object.opened = false;
      this.opened = false;
      this.activ = true;
      object.edit = false;
      this._dataset();
      this.customStyle['--bg-kleur'] = '#a4e5f9'; 
      this.updateStyles(); 
    },

    confirm: function(){
      var object = document.getElementById(this.objectname);
      console.log('test', object.edit);
      this.fire('save-it', { datasetkey: this.objectname, dataset: this.objectdata, hash: this.objecthash, config: this.objectconfig });
      // console.log("KLEUR! ", JSON.stringify(this.objectconfig));
      // Hier moet nog een check komen; als de hash van de nieuwe set data niet dezelfde is als de vorige hash moeten alle peers gedelete worden.
      object.opened = false;
      this.opened = false;
      this.activ = true;
      object.edit = false;
      console.log('test2', object.edit);
      object.selected = 0;
      this.customStyle['--bg-kleur'] = '#a4e5f9'; 
      this.updateStyles(); 
    },

    _toBack: function(){
      this.entryAnimation = 'slide-from-left-animation';
      this.exitAnimation = 'slide-right-animation';
      this.selected = 0;
    },

    _preview: function(){
      if(this.preview){
        this.mode = 1;
        var object = document.getElementById(this.objectname);
        object.mode = 1;
      } else {
        this.mode = 0;
        var object = document.getElementById(this.objectname);
        object.mode = 0;
      }
    },

    _tester:function(){
      console.log('Zo!');
    },

    toggleCollapse:function(){
      this.$.collapse.toggle();
    },

    object2array: function(input){
      var newarray = [];
      //var newarray = input;
      var p = input;
      for (var key in p) {
        if (p.hasOwnProperty(key)) {
          //console.log(key ," -> " , p[key]);
          //console.log(p[key].name);
          //newarray.push({
              //[key]: p[key]});
          newarray[key] = p[key];
        }

      };
      //this.newarray = newarray;
      return newarray;
    }



  });
})();
</script>
