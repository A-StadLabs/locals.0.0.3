<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animatable.html">


<script src="../../scripts/sha256.js"></script>
<script src="/../../scripts/enc-base64-min.js"></script>

<link rel="import" href="../lo-renderer/lo-renderer.html">


<dom-module id="lo-grid">
  <template>
    <style>
      :host {
        display: block;
        height: 100%;
      }

      .canvas {
        background: var(--primary-red);
        color: white;
        height: 100%;

        @apply(--layout-vertical);
        @apply(--layout-center);

        font-family: Opensans;
        -webkit-font-smoothing: antialiased;
      }

      .addbar {
        width: 100vw;
        height: 10%;
        min-height: 50px;
        background: transparent;
        padding: 10px;
        box-sizing:border-box;
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-end-justified);
      }

      .addbtn {
        height: 50px;
        min-height: 50px;
        width: 50px;
        min-height: 50px;
        border-radius: 50%;
        background-color: rgba(255,255,255,0.25);
        border: none;
        outline: 0;
        margin: 5px;
        padding: 0px;

      }
      .addbtn img {
        margin: 0px;
        padding: 0px;
      }


      .grid {
        background: rgba(0,0,0,0.1);
        width: 100vw;
        max-width: 900px;
      }

      h1,h2,p,a {
        margin: 0px;
        padding: 0px 
      }


    </style>
    <div class="canvas">

      <div class="addbar">
        <button class="addbtn" on-tap="FireAddData"><img src="../../images/add.svg"></button>
      </div>

      <div class="grid">
        <h1>Hier komen alle objects</h1>

      <template is="dom-repeat" items="{{objectsdata_new}}" id="collrepeat">

        <lo-object 
          objectcomponent="{{item.array.objectcomponent}}" 
          objectname="{{item.array.objectname}}" 
          objectconfig="{{item.array.objectconfig}}"
          objectdata="{{item.array.objectdata}}"
          objectpeers="{{item.array.objectpeers}}"
          publickey="{{publickey}}"
          hash="{{item.array.objecthash}}"
          width="{{item.array.width}}"
          height="{{item.array.height}}"
          locked="{{item.array.locked}}"
          >
        </lo-object>

      </template>



      </div>

    </div>
  </template>
 <script>
(function() {

  function hasher(hashobject){
    var hash = JSON.stringify(hashobject);
    var hash = CryptoJS.SHA256(hash);
    //console.log("te hashen: ", hashobject);
    //console.log("gehashed: ", hash.toString(CryptoJS.enc.Hex));
    return hash.toString(CryptoJS.enc.Hex); 
  };

  var lomqtt;

 

  Polymer({
    is: 'lo-grid',

    behaviors: [
        Polymer.NeonAnimatableBehavior
    ],

    properties: {
      publickey: {
        type: String,
        notify: true
      },

      loggedin: {
        type: Boolean,
        observer: "_log"
      },

      objectsdata: {
        type: Object,
        notify: true,
        observer: "_objectChanged"
      },

      objectsdata_new: {
        type: Array,
        notify: true
      },

      position: {
        type: Number,
        notify: true
      }


    },

    ready: function(){

      var that = this;

    },

    _selposchanged: function(){
      this.customStyle['--objectscollection-left'] = 280*this.position.toString()+"px";
      this.updateStyles();
    },

    attached: function(){
      lomqtt = document.querySelector("lo-mqtt");
      console.log("Objectscollection kent lomqtt: ", lomqtt);
    },

    toGod: function(){
      var stage = document.querySelector("lo-stage");
      stage.selected = 6;
    },

    _log: function(){
      //console.log("Loggedin? ",this.loggedin);
    },

    _objectChanged: function(){
      //console.log('updated: ',this.objectsdata.collection);
      this.objectsdata_new = [];
      var objectsdata_new = this.objectsdata_new;
      var p = this.objectsdata.collection;
      for (var key in p) {
        if (p.hasOwnProperty(key)) {
          //console.log(key + " -> " + p[key]);
          //console.log(p[key].name);
          this.push('objectsdata_new', { 
            array: {objectname: p[key].name, 
            objectconfig: p[key].config,
            objectdata: p[key].data,
            objectpeers: p[key].peers,
            objectcomponent: p[key].component,
            objecthash: hasher(p[key].data),
            objectlocked: p[key].locked }
          });
          
          //console.log('New objectsdata: ', objectsdata_new);
        }
      };
      this.customStyle['--objectscollection-width'] = 280*this.objectsdata_new.length.toString()+"px";
      this.updateStyles();
      this.objectsdata_new = objectsdata_new;
    },

    validate: function(e){
      var i = e.target.id;
      var data = this.objectsdata_new.collection[i].data;
      var config = this.objectsdata_new.collection[i].config;
      var name = this.objectsdata_new.collection[i].name;
      this.fire('qr-reader', {  
        command: "VERIFY", 
        objectname: name, 
        objectconfig: config, 
        objectdata: JSON.stringify(data) 
      });
    },

    _toQR: function(){
      this.fire('qr-identity');
    },

    _toQReader: function(){
      this.fire('qr-reader');
    },

    FireAddData: function(){
      this.fire('object-store');
    }

  });
})();
</script>

</dom-module>
